<!DOCTYPE html>
<html lang="en_US">
<head>
    <meta charset="utf-8" />
    <title>Our first pygame - grid movement - part 5  | Game Experiments</title>

    <meta name="viewport" content="width=device-width, initial-scale=1">

    
    <meta name="author" content="Richard Porteous">
    <meta name="description" content="Various coding tutorials">
    <meta name="keywords" content="blog, site, tutorials, coding, software, programming">

    
    <link href="https://richard-porteous.github.io/css/bootswatch/solar.min.css" rel="stylesheet">
    
    <link href="https://richard-porteous.github.io/css/font-awesome/css/font-awesome.min.css" rel="stylesheet">
    <link href="https://richard-porteous.github.io/css/custom.css" rel="stylesheet">

<link rel="icon" type="image/x-icon" href="https://richard-porteous.github.io/favicon.ico" />



<script type="text/javascript">
    var azbalacSettingHeaderMoveTitle = 'false';
</script>
<script src="https://richard-porteous.github.io/js/jquery-3.4.1.min.js"></script>
<script src="https://richard-porteous.github.io/js/functions.js"></script><style>body {}.footer-container { background-color: #29281f; }.footer-container { color: #f9fcf9; }</style>



<link id="typography-header-title-font" rel="stylesheet" href="https://fonts.googleapis.com/css?family=Exo%3A800"><style id="typography-title" type="text/css">#site-header-text a {
        font-family: Exo;
    }#site-header-text a {
        font-size: 50px; 
    }</style>

<link id="typography-header-subtitle-font" rel="stylesheet" href="https://fonts.googleapis.com/css?family=Exo%3A600"><style id="typography-subtitle" type="text/css">#site-description {
        font-family: Exo;
    }#site-description {
        font-size: 30px; 
    }</style>

<style id="typography-body" type="text/css"></style>

<style id="typography-navbar" type="text/css">nav#navbarMain {
        font-size: 20px; 
    }
    nav#navbarMain ul.dropdown-menu {
        font-size: 20px;
    }</style>

<link id="typography-headline-font" rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans"><style id="typography-headline" type="text/css">h1, h2, h3, h4, h5, h6 {
                font-family: Open Sans; 
            }</style>



    
    <script type="text/javascript">
        var azbalacSettingHeaderColor = { 'bg': '#000000',
            'transp': '0'
            };

    </script>
    <style type="text/css">
        #site-header-text a, #site-description {
                background: "#000000";  
            background:  rgba(0,0,0,0.00);
            
        }
    </style>
    
    
    <style type="text/css">
        #site-header-box-title {
            margin-bottom: 0px;
        }
    </style>
    
    
    <style type="text/css">
        #site-header-container-overlay {
        
            left: 20px;
        
        
            top: 20px;
        
        }
    </style>
    


<!-- HTML5 shim and Respond.js IE8 support of HTML5 elements and media queries -->
<!--[if lt IE 9]>
        <script src="//cdn.jsdelivr.net/npm/html5shiv@3.7.3/dist/html5shiv.min.js"></script>
        <script src="//cdn.jsdelivr.net/npm/respond.js@1.4.2/dest/respond.min.js"></script>
<![endif]-->


</head>


<body>

<div id="header" role="banner" style="">

    <div class="container">
        <header class="masthead">
            <div>
                <div id="site-header-container-above" class="row align-items-center">
                    
                </div>
            </div>


            

            <div id="site-header-above"><a href="https://richard-porteous.github.io/" rel="home">
                <picture>
                        <source media="(min-width: 1200px)" srcset="https://richard-porteous.github.io/img/header_background.jpg 1110w">
                        <source media="(min-width: 992px) and (max-width: 1199.98px)" srcset="https://richard-porteous.github.io/img/header_background.jpg 930w">
                        <source media="(min-width: 768px) and (max-width: 991.98px)" srcset="https://richard-porteous.github.io/img/header_background.jpg 690w">
                        <source media="(min-width: 576px) and (max-width: 767.98px)" srcset="https://richard-porteous.github.io/img/header_background.jpg 510w">
                        <source media="(max-width: 575.98px)" srcset="https://richard-porteous.github.io/img/header_background.jpg 476w">
                        <img id="site-header-image" src="https://richard-porteous.github.io/img/header_background.jpg" style="max-width: 100%; width: 100%">
                </picture>
                </a>

                <div id="site-header-container-overlay" class="position-absolute  fixed-top ">
                    <div id="site-header-box-title" class=" d-flex justify-content-start ">
                        <h1 class="azbalac-title" id="site-header-text"><a class="header-url" style="color: #FFFFFF;" href="https://richard-porteous.github.io/">Game Experiments</a></h1>
                    </div>
                    
                    <div id="site-header-box-subtitle" class=" d-flex justify-content-start ">   
                        <h2 class="azbalac-subtitle" id="site-description" style="color: #EEEEFF;">Learn with me</h2>
                    </div>
                </div>
                
             
            </div>

    
    <nav id="navbarMain" class="navbar navbar-expand-sm justify-content-between mb-3 navbar-dark bg-primary" role="navigation">
        
        <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarSupportedContent" aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation">
                <span class="navbar-toggler-icon"></span>
        </button>
      
            
            <div class="sticky-top navbar-collapse collapse  " id="navbarSupportedContent"> 
                <ul class="navbar-nav">

  
  <li class="nav-item ">
    <a class="nav-link" href="/">
      
      Home
    </a>
  </li>
  <span class="mx-2"></span>
  

  
  <li class="nav-item ">
    <a class="nav-link" href="/posts/">
      
      Blog
    </a>
  </li>
  <span class="mx-2"></span>
  

  
  <li class="nav-item ">
    <a class="nav-link" href="/about/">
      
      About &amp; Contact
    </a>
  </li>
  <span class="mx-2"></span>
  
</ul>
             
            </div>
        
            
    </nav> 
    



      </header>
    </div> 
</div>


    <div id="main">
        <div class="container">
            <div class="row"><div class="col-md" id="content">





<h1>Our first pygame - grid movement - part 5 </h1>

    <div class="post-meta"><span class="byline-icon fa fa-clock-o" aria-hidden="true"></span> <span class="screen-reader-text">Date: </span><time datetime="2024-01-17T17:35:57-07:00">17.01.2024</time> - 
    <span class="byline-icon fa fa-user" aria-hidden="true"></span><span class="screen-reader-text">Author: </span> Richard Porteous
     </div>


  <h2 id="quick-refactor-before-starting">Quick refactor before starting</h2>
<p>I mentioned in the last post we should do something with speed. Its used as a global inside the input class and I don&rsquo;t like that.
The original idea is to pass it in, but that wont work well because it is going to be used with delta time.</p>
<p>So here is a better idea. We will remove it.</p>
<ul>
<li>replace speed inside our input class with 1</li>
<li>remove speed from being initialized before its needed</li>
</ul>
<p>Now we replace a small bit of code:</p>
<pre tabindex="0"><code>    velocity = (x,y) = held_keys.get_first_of_remaining_pressed()
</code></pre><p>With this bit</p>
<pre tabindex="0"><code>    (x,y) = held_keys.get_first_of_remaining_pressed()
    velocity = (x * speed, y * speed)
</code></pre><p>Thats all! amazing.</p>
<h2 id="grid-movement">Grid Movement</h2>
<p>For Grid movement we want to move from the center of one tile to the center of the next.</p>
<ul>
<li>We could abandon the delta time and the incremental drawing of each step, and use either animation or tween.</li>
</ul>
<p>or</p>
<ul>
<li>We could use what we have and prevent turning until we reach our destination.</li>
</ul>
<p>I prefer the second, but the option is yours for your game. I&rsquo;ll show you how to implement this with the existing code.</p>
<h3 id="we-want">We want</h3>
<ul>
<li>move length i.e. the size of a tile</li>
<li>direction at start of move</li>
<li>a start point</li>
<li>a destination</li>
<li>a method to determine when we are close enough before we allow a turn.</li>
</ul>
<p>Sounds easy! Ok so lets see how easy it is, and if i&rsquo;ll be bug fixing once I&rsquo;m done.</p>
<p>We have some of this. I do need to add a few things.</p>
<p>we create two &lsquo;static&rsquo; variables i.e. ones we don&rsquo;t change</p>
<pre tabindex="0"><code>TILESIZE = (80,80)
PLAYERNORMALSPEED = 0.7
</code></pre><p>Place those at the top after the imports.</p>
<p>then we want a variable like speed that will be set to the Normal speed. I think we should create a new one and call it player current speed, so we know we can change it, i.e. make the worm go faster at certain intervals.</p>
<p>Before the game loop add</p>
<pre tabindex="0"><code>direction = (0,0)
from_tile = player_loc.center
player_current_speed = PLAYERNORMALSPEED
</code></pre><p>We added the direction for the duration of the move, a start point, and speed like we talked about.</p>
<p>Now we need to replace the following</p>
<pre tabindex="0"><code>    speed = 0.7 * dt
</code></pre><p>with</p>
<pre tabindex="0"><code>    dt_distance = player_current_speed * dt
</code></pre><p>and replace this</p>
<pre tabindex="0"><code>    (x,y) = held_keys.get_first_of_remaining_pressed()
    velocity = (x * speed, y * speed)
    player_loc = player_loc.move(velocity)
</code></pre><p>with</p>
<pre tabindex="0"><code>    #get direction from key pressed queue
    new_direction = held_keys.get_first_of_remaining_pressed()

    # get destination
    to_tile = (from_tile[0] + direction[0] * TILESIZE[0], from_tile[1] + direction[1] * TILESIZE[1])

    if direction != (0,0) or new_direction != (0,0):
        # print(&#34;movement&#34;) # debug statement

        dist_to_dest = abs(math.dist(player_loc.center, to_tile))
        # are we at the destination? i.e. close enough to get there.
        if (dist_to_dest &lt;= abs(dt_distance)):
            # print(&#34;end of movement&#34;) # debug statement
            
            # we only change direction when we are at the destination
            player_loc.center = to_tile
            from_tile = to_tile
            direction = new_direction
        else:
            # we are in a move - keep going
            velocity = (direction[0] * dt_distance, direction[1] * dt_distance)
            player_loc = player_loc.move(velocity)
</code></pre><p>So we:</p>
<ul>
<li>check if we have direction</li>
<li>if we are at the start/end of a move we allow a direction change</li>
<li>otherwise we keep moving</li>
</ul>
<p>Notice - we have the bonus of not moving at all until the first time we press a key. If you wanted the character to start moving right away you would likely need to set the new_direction if direction was (0,0).</p>
<h2 id="two-more-things">Two more things</h2>
<ol>
<li>Lets scale the board. Currently it does not have sufficient grid places and the player appears too big.</li>
<li>Lets add food in random places, and as a bonus eat a piece of food and place a piece of the tail on the board.</li>
</ol>
<p>The food is easier than it seems. We simply randomly generate a position, place it (we don&rsquo;t test if something is there, not yet), and if the head location matches the food location we place it in a new location and add a tail to the worm. We won&rsquo;t generate sounds, that is a later topic.</p>
<h3 id="copy-food-png">Copy food png</h3>
<p>Ok copy tile_coin.png and place it in assets/food folder which you&rsquo;ll need to create. copy it from the same place as we did when you copied in the head. We are pretending a coin is food.</p>
<p>The code you&rsquo;ll use is the same as what you did for the player. Try it yourself.</p>
<p>After the player moves you&rsquo;ll place the code that check to see if the food and the haed are in the center of the same tile</p>
<pre tabindex="0"><code>    if (player_loc.center == food_loc.center):
        x = random.randrange(0, 20)
        y = random.randrange(0, 14)
        food_loc.center = (80 * x + 80/2) , (80 * y + 80/2)
</code></pre><p>then you would blit the food before the player so it goes under the head when being eaten. Like so &hellip;</p>
<pre tabindex="0"><code>    # place image on the screen
    screen.blit(food, food_loc)
    screen.blit(player, player_loc)
</code></pre><p>Now we need to scale the screen, easiest is just to draw things smaller. If you have a better way, now it the time to implement.</p>
<p>Under tilesize definition you can add the following</p>
<pre tabindex="0"><code>SCALESIZE = 0.5
TILE_SIZE = (80,80)
TILESIZE = (TILE_SIZE[0] * SCALESIZE, TILE_SIZE[1] * SCALESIZE)

# this is modified
PLAYERNORMALSPEED = 0.4 * SCALESIZE
</code></pre><p>We also going to set window size to be a multiple of the square size</p>
<pre tabindex="0"><code>size = width, height = (800, 560)
</code></pre><p>We wont fill the screen directly - we will use a background texture. I&rsquo;m going to create with code.</p>
<pre tabindex="0"><code>#background
background = pygame.Surface.copy(screen)
background.fill(white)

#draw lines for the grid
for y in range(0, height, int(TILESIZE[0])):
    pygame.draw.line(background, black, (0,y), (width,y))
for x in range(0, width, int(TILESIZE[1])):
    pygame.draw.line(background, black, (x,0), (x,height))


screen.blit(background,(0,0))
</code></pre><p>We scale our current images</p>
<pre tabindex="0"><code>#player
player = pygame.image.load(&#34;assets/player/blue_body_squircle.png&#34;)
player = pygame.transform.scale_by(player, 0.5 )
player_loc = player.get_rect()
player_loc.center = width/2, height/2
player_loc.center = TILESIZE[0]/2, TILESIZE[1]/2

#food
eaten = False
food = pygame.image.load(&#34;assets/food/tile_coin.png&#34;)
food = pygame.transform.scale_by(food, 0.5 )
food_loc = food.get_rect()
food_loc.center = (TILESIZE[0] * 9 + TILESIZE[0]/2) , (TILESIZE[1] * 9 + TILESIZE[1]/2)
</code></pre><p>We fix the food placement to scale</p>
<pre tabindex="0"><code>    if (player_loc.center == food_loc.center):
        x = random.randrange(0, 20)
        y = random.randrange(0, 14)
        food_loc.center = (TILESIZE[0] * x + TILESIZE[0]/2) , (TILESIZE[1] * y + TILESIZE[1]/2)
</code></pre><p>and blit the background</p>
<pre tabindex="0"><code>screen.blit(background,(0,0))
</code></pre><h2 id="the-final-code-listing-looks-like-this">The final code listing looks like this</h2>
<pre tabindex="0"><code>import math
import random
import pygame
from pygame.locals import *


SCALESIZE = 0.5
TILE_SIZE = (80,80)
TILESIZE = (TILE_SIZE[0] * SCALESIZE, TILE_SIZE[1] * SCALESIZE)


PLAYERNORMALSPEED = 0.4 * SCALESIZE

# set window size
size = width, height = (800, 560)
screen = pygame.display.set_mode(size)

black = (0,0,0)
white = (255,255,255)
#screen.fill(white)

#background
background = pygame.Surface.copy(screen)
background.fill(white)

for y in range(0, height, int(TILESIZE[0])):
    pygame.draw.line(background, black, (0,y), (width,y))
for x in range(0, width, int(TILESIZE[1])):
    pygame.draw.line(background, black, (x,0), (x,height))

#player
player = pygame.image.load(&#34;assets/player/blue_body_squircle.png&#34;)
player = pygame.transform.scale_by(player, 0.5 )
player_loc = player.get_rect()
player_loc.center = TILESIZE[0]/2, TILESIZE[1]/2

#food
eaten = False
food = pygame.image.load(&#34;assets/food/tile_coin.png&#34;)
food = pygame.transform.scale_by(food, 0.5 )
food_loc = food.get_rect()
food_loc.center = (TILESIZE[0] * 9 + TILESIZE[0]/2) , (TILESIZE[1] * 9 + TILESIZE[1]/2)

screen.blit(background,(0,0))

# update the display to see what we set
pygame.display.update()

# Initialize the pygame code
pygame.init()
# Max frame rate
clock = pygame.time.Clock()
FPS = 60

#speed = 10
# control variable
game_running = True

# time based movement requires delta time
class deltatime():
    def __init__(self):
        self.last_loop = pygame.time.get_ticks()
        self.dt = 0


    def loop_time(self) -&gt; int:
        time_now_ms = pygame.time.get_ticks()
        dt = time_now_ms - self.last_loop
        self.last_loop = time_now_ms
        return dt
    

class keyisdown():
    
    def __init__(self) -&gt; None:
        self.key_queue = []

    def getEvents(self):
       
        for event in pygame.event.get():
            if event.type == QUIT or (event.type==pygame.KEYDOWN and event.key in [K_ESCAPE]):
                self.key_queue.clear()
                return False
            
            # KEEP KEY PRESS ORDER
            if event.type==pygame.KEYDOWN:
                if event.key == K_ESCAPE:
                    return False
                if event.key in [K_s, K_DOWN]:
                    self.key_queue.append(&#34;D&#34;)
                if event.key in [K_w, K_UP]:
                    self.key_queue.append(&#34;U&#34;)
                if event.key in [K_d, K_RIGHT]:
                    self.key_queue.append(&#34;R&#34;)
                if event.key in [K_a, K_LEFT]:
                    self.key_queue.append(&#34;L&#34;)

            # KEEP KEY PRESS ORDER (remove released from middle too)
            if event.type==pygame.KEYUP:
                if event.key in [K_s, K_DOWN]:
                    self.key_queue.remove(&#34;D&#34;)
                if event.key in [K_w, K_UP]:
                    self.key_queue.remove(&#34;U&#34;)
                if event.key in [K_d, K_RIGHT]:
                    self.key_queue.remove(&#34;R&#34;)
                if event.key in [K_a, K_LEFT]:
                    self.key_queue.remove(&#34;L&#34;)
        #if(self.upkey or self.rightkey or self.downkey or self.leftkey):
        #    print(&#34;up&#34;,self.upkey, &#34;right&#34;, self.rightkey, &#34;down&#34;, self.downkey, &#34;left&#34;, self.leftkey)
        return True
    
    def get_first_of_remaining_pressed(self):
        keys = pygame.key.get_pressed()

        while(len(self.key_queue) &gt; 0):
            match (self.key_queue[0]): 
                case &#34;U&#34;:
                    if keys[pygame.K_UP] or keys[pygame.K_w]:
                        return (0,-1)
                case &#34;D&#34;:
                    if keys[pygame.K_DOWN] or keys[pygame.K_s]:
                        return (0,1)
                case &#34;L&#34;:
                    if keys[pygame.K_LEFT] or keys[pygame.K_a]:
                        return (-1,0)
                case &#34;R&#34;:
                    if keys[pygame.K_RIGHT] or keys[pygame.K_d]:
                        return (1,0)
            
            #in-valid front of queue items are removed
            self.key_queue.pop(0)

        return(0,0)

    def clean_queue(self):
        self.key_queue = []
        

#initialize the classes
held_keys = keyisdown()
delta_time = deltatime()
direction = (0,0)
from_tile = player_loc.center
player_current_speed = PLAYERNORMALSPEED

#game loop
while game_running:
    clock.tick(FPS)

    # indicating the number of miliseconds since the last time that piece of code was run
    dt = delta_time.loop_time()
    dt_distance = player_current_speed * dt

    game_running = held_keys.getEvents()

    new_direction = held_keys.get_first_of_remaining_pressed()
    to_tile = (from_tile[0] + direction[0] * TILESIZE[0], from_tile[1] + direction[1] * TILESIZE[1])

    # we have a direction
    if direction != (0,0) or new_direction != (0,0):
        #print(&#34;movement&#34;)
        # are we there yet?
        dist_to_dest = abs(math.dist(player_loc.center, to_tile))
        if (dist_to_dest &lt;= abs(dt_distance)):
            player_loc.center = to_tile
            from_tile = to_tile
            #print(&#34;end of contineous movement&#34;)
            direction = new_direction
        else:
            velocity = (direction[0] * dt_distance, direction[1] * dt_distance)
            player_loc = player_loc.move(velocity)


    if (player_loc.center == food_loc.center):
        x = random.randrange(0, 20)
        y = random.randrange(0, 14)
        food_loc.center = (TILESIZE[0] * x + TILESIZE[0]/2) , (TILESIZE[1] * y + TILESIZE[1]/2)
        

    #clear the display
    screen.blit(background,(0,0))

    # place image on the screen
    screen.blit(food, food_loc)
    screen.blit(player, player_loc)

    # apply changes
    pygame.display.update()


# quit the pygame window
pygame.quit()
#the app exits
</code></pre><p>I take the code directly from the git repository. I suggest you do the same.</p>
<p><a href="/posts/pygame/worm-4/">Prev Post</a> - <a href="/posts/pygame/worm-6/">Next Post</a></p>


                </div></div>
        </div>
    </div>

    
        <div class="footer-container" style="">
    <div class="container">
        <footer>

            <div class="row">
            
            
                
                    <div class="col">
    <!-- raw HTML omitted -->
<!-- raw HTML omitted -->

</div>
                
                    <div class="col">
    
</div>
                
                    <div class="col">
    
</div>
                
            

            </div>
        </footer>
    </div>
</div>
    
    
        
<div class="subfooter-container">

    <div class="container">
        <div class="footer">
            <div class="row wrapper padding">
                <div class="col-xs-12 col-md-12">

            
            
                
                        <p>Powered by <a href="https://gohugo.io">Hugo</a>. Theme <a href="https://github.com/geschke/hugo-tikva">Tikva</a> by <a href="https://www.kuerbis.org">Ralf Geschke</a>.</p>


                
            
                  
                </div>
            </div>
        </div>
    </div>
</div>

    

    <div id="media-width-detection-element"></div>

<script src="https://richard-porteous.github.io/js/popper.min.js"></script>
<script src="https://richard-porteous.github.io/js/bootstrap.min.js"></script>


</body>
</html>